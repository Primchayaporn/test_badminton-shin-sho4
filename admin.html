<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super Admin - SHIN-SHO</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1a237e; --success: #00c853; --danger: #ef4444; --bg: #f4f6f9; }
        body { font-family: 'Kanit', sans-serif; background-color: var(--bg); margin: 0; }
        header { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .btn-nav { text-decoration: none; color: white; background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 12px; font-size: 14px; border:none; cursor:pointer; }
        
        .admin-grid { display: grid; grid-template-columns: 1fr; gap: 20px; padding: 20px; }
        @media (min-width: 1100px) { .admin-grid { grid-template-columns: 400px 1fr; } }

        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤ */
        .status-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .status-table th { background: #f8f9fa; padding: 12px; color: var(--primary); border-bottom: 2px solid var(--primary); }
        .status-table td { padding: 8px; border-bottom: 1px solid #f0f0f0; text-align: center; }
        
        .slot-free { color: var(--success); font-weight: 600; background: #e8f5e9; border-radius: 20px; padding: 4px 12px; font-size: 12px; }
        .slot-busy { color: var(--danger); font-weight: 600; background: #ffebee; border-radius: 20px; padding: 4px 12px; font-size: 12px; cursor: pointer; border:none; }

        /* ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≠‡∏á Walk-in */
        .walkin-form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .walkin-form input, .walkin-form select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-family: 'Kanit'; box-sizing: border-box; }
        .btn-walkin { grid-column: span 2; background: var(--success); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: 600; margin-top: 5px; }

        /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á */
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .data-table th { background: #f8f9fa; padding: 12px; text-align: left; }
        .data-table td { padding: 12px; border-bottom: 1px solid #eee; }
        .status-badge { padding: 4px 10px; border-radius: 20px; color: white; font-size: 11px; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; }
        #mSlip { width: 100%; max-height: 350px; object-fit: contain; margin: 15px 0; border-radius: 10px; border: 1px solid #ddd; }
    </style>
</head>
<body>

<header>
    <div class="logo">SHIN-SHO SUPER ADMIN</div>
    <div style="display: flex; gap: 10px;">
        <button class="btn-nav" onclick="location.href='index.html'">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
        <button class="btn-nav" style="background:var(--danger);" onclick="logout()">üö™ ‡∏≠‡∏≠‡∏Å</button>
    </div>
</header>

<div class="admin-grid">
    <div>
        <div class="card">
            <h3 style="margin-top:0;">üè∏ ‡∏à‡∏≠‡∏á Walk-in</h3>
            <div class="walkin-form">
                <input type="text" id="walkinName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á (Walk-in)" style="grid-column: span 2;">
                <input type="date" id="adminDate" onchange="loadAdminData()">
                <select id="walkinCourt" onchange="loadAdminData()">
                    <option value="A">‡∏™‡∏ô‡∏≤‡∏° A</option>
                    <option value="B">‡∏™‡∏ô‡∏≤‡∏° B</option>
                </select>
                <select id="startTime" onchange="updateEndOptions()"></select>
                <select id="endTime"></select>
                <button class="btn-walkin" id="btnWalkin" onclick="bookWalkin()">‚ûï ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≠‡∏á‡∏™‡∏ô‡∏≤‡∏°</button>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-top:0;">üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏ô‡∏≤‡∏°</h3>
            <table class="status-table">
                <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏™‡∏ô‡∏≤‡∏° A</th><th>‡∏™‡∏ô‡∏≤‡∏° B</th></tr></thead>
                <tbody id="gridBody"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
            <button onclick="loadAll()" style="border:none; background:#e3f2fd; color:var(--primary); padding:8px 15px; border-radius:20px; cursor:pointer;">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        </div>
        <div style="overflow-x:auto;">
            <table class="data-table">
                <thead><tr><th>‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏™‡∏ô‡∏≤‡∏°</th><th>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody id="adminAllBookings"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="manageModal" class="modal">
    <div class="modal-content">
        <h3 id="mTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3>
        <div id="mInfo" style="text-align:left; font-size:14px; background:#f8f9fa; padding:15px; border-radius:12px; margin-bottom:10px;"></div>
        <img id="mSlip" src="" style="display:none;">
        <p id="noSlipText" style="color:var(--danger); display:none;">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏•‡∏¥‡∏õ</p>
        <button id="btnConfirmPay" class="btn-walkin" style="background:var(--primary); margin-bottom:10px;" onclick="confirmPayment()">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
        <button class="btn-walkin" style="background:var(--danger);" onclick="deleteBooking()">üóëÔ∏è ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
        <button onclick="closeModal()" style="background:none; border:none; color:#999; margin-top:10px; cursor:pointer;">‡∏õ‡∏¥‡∏î</button>
    </div>
</div>

<script src="config.js"></script>
<script>
    const URL = CONFIG.WEB_APP_URL;
    const times = ["08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"];
    let allData = [];
    let currentId = "";

    window.onload = () => {
        document.getElementById('adminDate').value = new Date().toISOString().split('T')[0];
        loadAll();
    };

    async function loadAll() {
        const res = await fetch(`${URL}?action=getAllBookings`);
        allData = await res.json();
        renderMainTable();
        loadAdminData();
    }

    function renderMainTable() {
        document.getElementById('adminAllBookings').innerHTML = allData.map(item => `
            <tr>
                <td><b>${item.date}</b><br><small>${item.time}</small></td>
                <td>‡∏™‡∏ô‡∏≤‡∏° ${item.court}</td>
                <td>${item.userName}</td>
                <td><span class="status-badge" style="background:${getStatusColor(item.status)}">${item.status}</span></td>
                <td><button onclick="openManageModal('${item.id}')" style="cursor:pointer;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</button></td>
            </tr>
        `).reverse().join('');
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÅ‡∏•‡∏∞ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dropdown ‡πÄ‡∏ß‡∏•‡∏≤ Walk-in (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Index)
    function loadAdminData() {
        const selectedDate = document.getElementById('adminDate').value;
        const court = document.getElementById('walkinCourt').value;
        
        // 1. ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        document.getElementById('gridBody').innerHTML = times.map(t => {
            const bookingA = checkBookingAtTime(t, 'A', selectedDate);
            const bookingB = checkBookingAtTime(t, 'B', selectedDate);
            return `<tr><td>${t}</td><td>${renderSlot(bookingA)}</td><td>${renderSlot(bookingB)}</td></tr>`;
        }).join('');

        // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dropdown "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Walk-in (‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡∏≠‡∏≠‡∏Å)
        const available = times.filter(t => !checkBookingAtTime(t, court, selectedDate));
        document.getElementById('startTime').innerHTML = available.map(t => `<option value="${t}">${t}</option>`).join('');
        updateEndOptions();
    }

    function updateEndOptions() {
        const start = document.getElementById('startTime').value;
        if(!start) return;
        const idx = times.indexOf(start);
        let opt = "";
        for(let i=idx+1; i<times.length; i++) opt += `<option value="${times[i]}">${times[i]}</option>`;
        opt += `<option value="00:00">00:00</option>`;
        document.getElementById('endTime').innerHTML = opt;
    }

    async function bookWalkin() {
        const name = document.getElementById('walkinName').value;
        if(!name) return alert("‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á Walk-in");
        
        const btn = document.getElementById('btnWalkin');
        btn.disabled = true; btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

        const payload = {
            action: "booking",
            userId: "WALK-IN",
            userName: "Walk-in: " + name,
            phone: "-",
            courtId: document.getElementById('walkinCourt').value,
            date: document.getElementById('adminDate').value,
            startTime: document.getElementById('startTime').value,
            endTime: document.getElementById('endTime').value,
            status: "‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß" // Walk-in ‡∏°‡∏±‡∏Å‡∏à‡∏∞‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÄ‡∏•‡∏¢
        };

        await fetch(URL, { method: "POST", body: JSON.stringify(payload) });
        alert("‚úÖ ‡∏à‡∏≠‡∏á Walk-in ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        document.getElementById('walkinName').value = "";
        btn.disabled = false; btn.innerText = "‚ûï ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≠‡∏á‡∏™‡∏ô‡∏≤‡∏°";
        loadAll();
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ß‡∏•‡∏≤
    function checkBookingAtTime(time, court, selectedDate) {
        const t = parseInt(time.replace(':',''));
        return allData.find(b => {
            if (b.court !== court || b.date !== formatDisplayDate(selectedDate) || b.status === "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å") return false;
            const [startStr, endStr] = b.time.split(' - ');
            const s = parseInt(startStr.replace(':',''));
            const e = (endStr === "00:00") ? 2400 : parseInt(endStr.replace(':',''));
            return t >= s && t < e;
        });
    }

    function renderSlot(booking) {
        return booking ? `<button class="slot-busy" onclick="openManageModal('${booking.id}')">‡πÄ‡∏ï‡πá‡∏° (‡∏î‡∏π)</button>` : `<span class="slot-free">‡∏ß‡πà‡∏≤‡∏á</span>`;
    }

    function openManageModal(id) {
        const item = allData.find(x => x.id == id);
        if(!item) return;
        currentId = id;
        document.getElementById('mTitle').innerText = `‡∏™‡∏ô‡∏≤‡∏° ${item.court} (${item.time})`;
        document.getElementById('mInfo').innerHTML = `<b>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á:</b> ${item.userName}<br><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ${item.status}`;
        const img = document.getElementById('mSlip');
        const noSlip = document.getElementById('noSlipText');
        if(item.slip && item.slip.length > 50) { img.src = item.slip; img.style.display = "block"; noSlip.style.display = "none"; }
        else { img.style.display = "none"; noSlip.style.display = "block"; }
        document.getElementById('btnConfirmPay').style.display = (item.status === '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß') ? 'none' : 'block';
        document.getElementById('manageModal').style.display = "flex";
    }

    function closeModal() { document.getElementById('manageModal').style.display = "none"; }
    async function confirmPayment() {
        await fetch(URL, {method:"POST", body:JSON.stringify({action:"updateStatus", id:currentId})});
        closeModal(); loadAll();
    }
    async function deleteBooking() {
        if(!confirm("‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á?")) return;
        await fetch(URL, {method:"POST", body:JSON.stringify({action:"delete", id:currentId})});
        closeModal(); loadAll();
    }
    function getStatusColor(s) { return s === '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß' ? '#00c853' : (s === '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ' ? '#0288d1' : '#f59e0b'); }
    function formatDisplayDate(dateStr) { const [y, m, d] = dateStr.split('-'); return `${d}/${m}/${y}`; }
    function logout() { localStorage.clear(); location.href = "login.html"; }
</script>
</body>
</html>